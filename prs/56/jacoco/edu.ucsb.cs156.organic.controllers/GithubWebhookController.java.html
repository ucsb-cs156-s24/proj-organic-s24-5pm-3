<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GithubWebhookController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">organic</a> &gt; <a href="index.source.html" class="el_package">edu.ucsb.cs156.organic.controllers</a> &gt; <span class="el_source">GithubWebhookController.java</span></div><h1>GithubWebhookController.java</h1><pre class="source lang-java linenums">package edu.ucsb.cs156.organic.controllers;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.beans.factory.annotation.Value;

import java.net.http.HttpResponse;
import java.nio.file.AccessDeniedException;

import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import javax.servlet.http.HttpServletResponse;

@Tag(name = &quot;Courses&quot;)
@RequestMapping(&quot;/githubwebhook&quot;)
@RestController
<span class="fc" id="L24">@Slf4j</span>
<span class="fc" id="L25">public class GithubWebhookController {</span>
    // @Autowired
    // CourseRepository courseRepository;
    // @Autowired
    // StaffRepository courseStaffRepository;
    // @Autowired
    // SchoolRepository schoolRepository;
    // @Autowired
    // UserRepository userRepository;
    // @Autowired
    // StudentRepository studentRepository;
    // @Autowired
    // GitHubApp gitHubApp;
    // @Autowired
    // GitHubToken accessToken;
    // @Autowired
    // GitHubUserApi gitHubUserApi;
    @Value(&quot;${edu.ucsb.cs156.github.webhookSecret}&quot;)
    String webhookSecret;

<span class="fc" id="L45">    private final String ALGORITHM = &quot;HmacSHA256&quot;;</span>

    @Operation(summary = &quot;Process a GitHub webhook payload&quot;, description = &quot;Process a GitHub webhook payload&quot;)
    // @PreAuthorize(&quot;hasAnyRole('ROLE_USER', 'ROLE_ADMIN')&quot;)
    @PostMapping(value = &quot;/process&quot;, consumes = &quot;application/json&quot;)

    public void allCourses(@RequestHeader(value = &quot;X-Hub-Signature-256&quot;) String signature,
            @Parameter(name = &quot;id&quot;) @RequestBody String payload, HttpServletResponse response) throws Exception {
        // Sample json on INSTALL (this is valuable for testing) :
        // {&quot;action&quot;:&quot;created&quot;,&quot;installation&quot;:{&quot;id&quot;:51336299,&quot;account&quot;:{&quot;login&quot;:&quot;ucsb-cs-dev&quot;,&quot;id&quot;:132534027,&quot;node_id&quot;:&quot;O_kgDOB-ZPCw&quot;,&quot;avatar_url&quot;:&quot;https://avatars.githubusercontent.com/u/132534027?v=4&quot;,&quot;gravatar_id&quot;:&quot;&quot;,&quot;url&quot;:&quot;https://api.github.com/users/ucsb-cs-dev&quot;,&quot;html_url&quot;:&quot;https://github.com/ucsb-cs-dev&quot;,&quot;followers_url&quot;:&quot;https://api.github.com/users/ucsb-cs-dev/followers&quot;,&quot;following_url&quot;:&quot;https://api.github.com/users/ucsb-cs-dev/following{/other_user}&quot;,&quot;gists_url&quot;:&quot;https://api.github.com/users/ucsb-cs-dev/gists{/gist_id}&quot;,&quot;starred_url&quot;:&quot;https://api.github.com/users/ucsb-cs-dev/starred{/owner}{/repo}&quot;,&quot;subscriptions_url&quot;:&quot;https://api.github.com/users/ucsb-cs-dev/subscriptions&quot;,&quot;organizations_url&quot;:&quot;https://api.github.com/users/ucsb-cs-dev/orgs&quot;,&quot;repos_url&quot;:&quot;https://api.github.com/users/ucsb-cs-dev/repos&quot;,&quot;events_url&quot;:&quot;https://api.github.com/users/ucsb-cs-dev/events{/privacy}&quot;,&quot;received_events_url&quot;:&quot;https://api.github.com/users/ucsb-cs-dev/received_events&quot;,&quot;type&quot;:&quot;Organization&quot;,&quot;site_admin&quot;:false},&quot;repository_selection&quot;:&quot;selected&quot;,&quot;access_tokens_url&quot;:&quot;https://api.github.com/app/installations/51336299/access_tokens&quot;,&quot;repositories_url&quot;:&quot;https://api.github.com/installation/repositories&quot;,&quot;html_url&quot;:&quot;https://github.com/organizations/ucsb-cs-dev/settings/installations/51336299&quot;,&quot;app_id&quot;:866461,&quot;app_slug&quot;:&quot;ucsb-cs-linker&quot;,&quot;target_id&quot;:132534027,&quot;target_type&quot;:&quot;Organization&quot;,&quot;permissions&quot;:{&quot;members&quot;:&quot;write&quot;,&quot;organization_administration&quot;:&quot;write&quot;},&quot;events&quot;:[&quot;member&quot;,&quot;membership&quot;,&quot;organization&quot;],&quot;created_at&quot;:&quot;2024-05-29T13:46:04.000-07:00&quot;,&quot;updated_at&quot;:&quot;2024-05-29T13:46:04.000-07:00&quot;,&quot;single_file_name&quot;:null,&quot;has_multiple_single_files&quot;:false,&quot;single_file_paths&quot;:[],&quot;suspended_by&quot;:null,&quot;suspended_at&quot;:null},&quot;repositories&quot;:[],&quot;requester&quot;:null,&quot;sender&quot;:{&quot;login&quot;:&quot;yuxiaolejs&quot;,&quot;id&quot;:43783877,&quot;node_id&quot;:&quot;MDQ6VXNlcjQzNzgzODc3&quot;,&quot;avatar_url&quot;:&quot;https://avatars.githubusercontent.com/u/43783877?v=4&quot;,&quot;gravatar_id&quot;:&quot;&quot;,&quot;url&quot;:&quot;https://api.github.com/users/yuxiaolejs&quot;,&quot;html_url&quot;:&quot;https://github.com/yuxiaolejs&quot;,&quot;followers_url&quot;:&quot;https://api.github.com/users/yuxiaolejs/followers&quot;,&quot;following_url&quot;:&quot;https://api.github.com/users/yuxiaolejs/following{/other_user}&quot;,&quot;gists_url&quot;:&quot;https://api.github.com/users/yuxiaolejs/gists{/gist_id}&quot;,&quot;starred_url&quot;:&quot;https://api.github.com/users/yuxiaolejs/starred{/owner}{/repo}&quot;,&quot;subscriptions_url&quot;:&quot;https://api.github.com/users/yuxiaolejs/subscriptions&quot;,&quot;organizations_url&quot;:&quot;https://api.github.com/users/yuxiaolejs/orgs&quot;,&quot;repos_url&quot;:&quot;https://api.github.com/users/yuxiaolejs/repos&quot;,&quot;events_url&quot;:&quot;https://api.github.com/users/yuxiaolejs/events{/privacy}&quot;,&quot;received_events_url&quot;:&quot;https://api.github.com/users/yuxiaolejs/received_events&quot;,&quot;type&quot;:&quot;User&quot;,&quot;site_admin&quot;:false}}
        // signature header:
        // sha256=38433304c66fa9ebac84f11964b9035dfc923893ed49a8dfb82d4f0fd3da9e23

        // Verify signature
<span class="nc" id="L59">        final SecretKeySpec secret_key = new SecretKeySpec(webhookSecret.getBytes(&quot;UTF-8&quot;), ALGORITHM);</span>
<span class="nc" id="L60">        final Mac sha256_HMAC = Mac.getInstance(ALGORITHM);</span>
<span class="nc" id="L61">        sha256_HMAC.init(secret_key);</span>
<span class="nc" id="L62">        final String trusted = &quot;sha256=&quot; + byteArrayToHex(sha256_HMAC.doFinal(payload.getBytes(&quot;UTF-8&quot;)));</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (!trusted.equals(signature)) {</span>
<span class="nc" id="L64">            log.error(&quot;\u001B[33mVALIDATION FAILED\u001B[0m: Sec &quot; + webhookSecret + &quot; - Sig &quot; + signature + &quot; - Exp &quot;</span>
                    + trusted);
            // throw new AccessDeniedException(&quot;Invalid signature&quot;);
<span class="nc" id="L67">            response.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L68">            return;</span>
        }
<span class="nc" id="L70">        log.warn(&quot;\u001B[33m&quot; + payload + &quot;\u001B[0m:&quot; + webhookSecret + &quot; - &quot; + signature);</span>
<span class="nc" id="L71">        response.setStatus(HttpServletResponse.SC_OK);</span>
<span class="nc" id="L72">    }</span>

    // https://gist.github.com/lesstif/655f6b295a619306405621e02634a08d
    public static String byteArrayToHex(byte[] a) {
<span class="nc" id="L76">        StringBuilder sb = new StringBuilder(a.length * 2);</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        for (byte b : a)</span>
<span class="nc" id="L78">            sb.append(String.format(&quot;%02x&quot;, b));</span>
<span class="nc" id="L79">        return sb.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>